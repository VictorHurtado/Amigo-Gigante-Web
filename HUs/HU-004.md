# HU-004 — Flujo Debug End-to-End (Presentation → UseCase → Repository → Infrastructure)

**Como** desarrollador  
**Quiero** un flujo mínimo “Debug” que conecte todas las capas (Presentation → Domain → Infrastructure)  
**Para** validar que la arquitectura, el enrutamiento (Next App Router) y el IoC (Inversify) funcionan de punta a punta

---

## Dependencias

- Requiere HU-001 (Next.js App Router funcionando)
- Requiere HU-002 (estructura por capas en `src/`)
- Requiere HU-003 (Inversify configurado con container + types + módulos)

---

## Alcance

Incluye:
- Un caso de uso `DebugUseCase`
- Un repositorio de dominio `IDebugRepository`
- Una implementación `DebugRepository`
- Un servicio de infraestructura opcional `DebugService` (o `ExampleService`) para demostrar wiring
- Una página UI `/debug` con un botón que ejecute el UseCase y muestre el resultado
- Manejo básico de `loading` y `error` en UI

No incluye:
- Redux
- Supabase
- Estilos avanzados
- Tests exhaustivos (solo smoke test mínimo requerido abajo)

---

## Criterios de aceptación (Given / When / Then)

### 1) Contratos en Domain

- **Dado** el directorio `src/domain`
- **Cuando** se implemente Debug
- **Entonces** debe existir:
  - `src/domain/repositories/IDebugRepository.ts`
  - `src/domain/usecases/debug/DebugUseCase.ts`
  - exports en `src/domain/repositories/index.ts` y `src/domain/usecases/index.ts` (si existen)

Y la interfaz `IDebugRepository` debe declarar al menos:

- `run(): Promise<string>`

---

### 2) Implementación en Infrastructure

- **Dado** el directorio `src/infrastructure`
- **Cuando** se implemente Debug
- **Entonces** debe existir:
  - `src/infrastructure/repositories/DebugRepository.ts`
  - (Opcional) `src/infrastructure/services/DebugService.ts`

`DebugRepository` debe:
- Implementar `IDebugRepository`
- Retornar un string generado en Infrastructure (ej: timestamp ISO o UUID simple)
- No usar APIs externas ni red

---

### 3) Registro en IoC (Inversify)

- **Dado** el contenedor IoC existente
- **Cuando** se registre Debug
- **Entonces** debe ser posible resolver:
  - `DebugUseCase` desde el container
  - `IDebugRepository` (binding a `DebugRepository`)

Debe existir un símbolo en:
- `src/infrastructure/ioc/repositories/repositories.types.ts`
- `src/infrastructure/ioc/usecases/usecases.types.ts`

Y sus bindings en:
- `repositories.container.ts`
- `usecases.container.ts`

---

### 4) Página /debug funcional

- **Dado** el proyecto Next.js con App Router
- **Cuando** el usuario visite `/debug`
- **Entonces** debe ver:
  - Título “Debug”
  - Botón “Run debug”
  - Área para mostrar resultado o error

- **Dado** el usuario en `/debug`
- **Cuando** haga clic en “Run debug”
- **Entonces** se debe ejecutar el flujo:

```
Presentation → UseCase → Repository → (Service opcional)
```

y se debe mostrar un string resultado en pantalla.

---

### 5) Smoke test manual + build

- **Dado** el repo actualizado
- **Cuando** se ejecute:
  - `npm run dev`
  - `npm run build`
- **Entonces** no debe haber errores.

---

## Reglas técnicas

- ❌ No agregar dependencias nuevas
- ❌ No Redux
- ❌ No Supabase
- `Domain` no importa nada de `inversify`, `next`, `react`
- `Presentation` no importa `DebugRepository` directamente (solo `DebugUseCase` vía container)
- `Infrastructure` es el único lugar donde vive el wiring IoC

---

## Implementación sugerida (estructura)

### Domain
- `src/domain/repositories/IDebugRepository.ts`
- `src/domain/usecases/debug/DebugUseCase.ts`

### Infrastructure
- `src/infrastructure/repositories/DebugRepository.ts`
- `src/infrastructure/services/DebugService.ts` (opcional)
- `src/infrastructure/ioc/repositories/repositories.types.ts` (agregar símbolo)
- `src/infrastructure/ioc/repositories/repositories.container.ts` (agregar binding)
- `src/infrastructure/ioc/usecases/usecases.types.ts` (agregar símbolo)
- `src/infrastructure/ioc/usecases/usecases.container.ts` (agregar binding)

### Presentation (Next App Router)
- `src/app/debug/page.tsx`
- (Opcional) `src/presentation/hooks/useDebug.ts`

---

## Definición de Hecho

- `/debug` existe y funciona en `npm run dev`
- Click en “Run debug” muestra un resultado
- `npm run build` OK
- Sin violaciones de capas
- Commit sugerido:
  `feat: add debug end-to-end flow`
